[TOC]



## 1、 IP（网络层） 和 MAC （数据链路层）之间的区别和关系

MAC 的作用则是实现「直连」的两个设备之间通信，而 IP 则负责在「没有直连」的两个网络之间进行通信传输

源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917123701916.png" alt="image-20220917123701916" style="zoom:67%;" />



## 2、什么是 A、B、C 类地址？

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917124436099.png" alt="image-20220917124436099" style="zoom:50%;" />



## 3、A、B、C 分类地址最大主机个数是如何计算的呢？

最大主机个数，就是要看主机号的位数，再进行以2为底的幂之后减去两个特殊的IP

- 主机号全为 1 指定某个网络下的所有主机，用于广播
- 主机号全为 0 指定某个网络

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917124617127.png" alt="image-20220917124617127" style="zoom:67%;" />

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917125631639.png" alt="image-20220917125631639" style="zoom:50%;" />



## 4、广播地址用于什么？

广播地址用于在**同一个链路中相互连接的主机之间发送数据包**。

- **在本网络内广播的叫做本地广播**。例如网络地址为 192.168.0.0/24 的情况下，广播地址是 192.168.0.255 。因为这个广播地址的 IP 包会被路由器屏蔽，所以不会到达 192.168.0.0/24 以外的其他链路上。
- **在不同网络之间的广播叫做直接广播**。例如网络地址为 192.168.0.0/24 的主机向 192.168.1.255/24 的目标地址发送 IP 包。收到这个包的路由器，将数据转发给 192.168.1.0/24，从而使得所有 192.168.1.1~192.168.1.254 的主机都能收到这个包（由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发。） 。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917124853961.png" alt="image-20220917124853961" style="zoom: 80%;" />



## 5、什么是 D、E 类地址？

D 类和 E 类地址是没有主机号的，所以不可用于主机 IP，D 类常被用于**多播**，E 类是预留的分类，暂时未使用。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917125648435.png" alt="image-20220917125648435" style="zoom:50%;" />



## 6、多播地址用于什么？

多播用于**将包发送给特定组内的所有主机。**

由于广播无法穿透路由，若想给其他网段发送同样的包，就可以使用可以穿透路由的多播。



多播使用的 D 类地址，其前四位是 `1110` 就表示是多播地址，而剩下的 28 位是多播的组编号。

从 224.0.0.0 ~ 239.255.255.255 都是多播的可用范围，其划分为以下三类：

- 224.0.0.0 ~ 224.0.0.255 为预留的组播地址，只能在局域网中，路由器是不会进行转发的。
- 224.0.1.0 ~ 238.255.255.255 为用户可用的组播地址，可以用于 Internet 上。
- 239.0.0.0 ~ 239.255.255.255 为本地管理组播地址，可供内部网在内部使用，仅在特定的本地范围内有效。



## 7、IP 分类的缺点

**同一网络下没有地址层次**

比如一个公司里用了 B 类地址，但是可能需要根据生产环境、测试环境、开发环境来划分地址层次，而这种 IP 分类是没有地址层次划分的功能，所以这就**缺少地址的灵活性**。



**不能很好的与现实网络匹配**

- C 类地址能包含的最大主机数量实在太少了，只有 254 个，估计一个网吧都不够用。
- 而 B 类地址能包含的最大主机数量又太多了，6 万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。



## 8、 无分类地址 CIDR是如何设计的

32 比特的 IP 地址被划分为两部分，前面是**网络号**，后面是**主机号**

表示形式 `a.b.c.d/x`，其中 `/x` 表示前 x 位属于**网络号**， x 的范围是 `0 ~ 32`



## 9、什么是**子网掩码**

划分网络号与主机号形式

掩盖掉主机号，剩余的就是网络号，**将子网掩码和 IP 地址按位计算 AND，就可得到网络号**

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917130639445.png" alt="image-20220917130639445" style="zoom:50%;" />



## 10、为什么要分离网络号和主机号？

因为两台计算机要通讯，首先要判断是否处于同一个广播域内，即网络地址是否相同。如果网络地址相同，表明接受方在本网络上，那么可以把数据包直接发送到目标主机。

路由器寻址工作中，也就是通过这样的方式来找到对应的网络号的，进而把数据包转发给对应的网络内。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917131500139.png" alt="image-20220917131500139" style="zoom:50%;" />



## 11、怎么进行子网划分？

**子网划分实际上是将主机地址分为两个部分：子网网络地址和子网主机地址**

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917131550795.png" alt="image-20220917131550795" style="zoom:50%;" />

使用子网掩码**划分子网**

假设对 C 类地址进行子网划分，网络地址 192.168.1.0，使用子网掩码 255.255.255.192 

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917131751367.png" alt="image-20220917131751367" style="zoom:50%;" />

由于子网网络地址被划分成 2 位，那么子网地址就有 4 个，分别是 00、01、10、11

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917131829112.png" alt="image-20220917131829112" style="zoom: 67%;" />

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917131847455.png" alt="image-20220917131847455" style="zoom:67%;" />



## 12、公有 IP 地址与私有 IP 地址是什么

在 A、B、C 分类地址，实际上有分公有 IP 地址和私有 IP 地址。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917132056835.png" alt="image-20220917132056835" style="zoom:80%;" />

私有IP允许组织内部的 IT 人员自己管理、自己分配，而且可以重复，即不同组织可以拥有相同的私有IP

公有 IP 地址是由 `ICANN` 组织管理，中文叫「互联网名称与数字地址分配机构」，全世界都是唯一的。



## 13、 IP 地址与路由控制

在发送 IP 包时，首先要确定 IP 包首部中的目标地址，再从路由控制表中找到与该地址具有**相同网络地址**的记录，根据该记录将 IP 包转发给相应的下一个路由器。如果路由控制表中存在多条相同网络地址的记录，就选择相同位数最多的网络地址，也就是最长匹配。

1. 主机 A 要发送一个 IP 包，其源地址是 `10.1.1.30` 和目标地址是 `10.1.2.10`，由于没有在主机 A 的路由表找到与目标地址 `10.1.2.10` 相同的网络地址，于是包被转发到默认路由（路由器 `1` ）
2. 路由器 `1` 收到 IP 包后，也在路由器 `1` 的路由表匹配与目标地址相同的网络地址记录，发现匹配到了，于是就把 IP 数据包转发到了 `10.1.0.2` 这台路由器 `2`
3. 路由器 `2` 收到后，同样对比自身的路由表，发现匹配到了，于是把 IP 包从路由器 `2` 的 `10.1.2.1` 这个接口出去，最终经过交换机把 IP 数据包转发到了目标主机



## 14、 IP 分片与重组

每种数据链路的最大传输单元 `MTU` 都是不相同的，如 FDDI 数据链路 MTU 4352、以太网的 MTU 是 1500 字节等。

那么当 IP 数据包大小大于 MTU 时， IP 数据包就会被分片。

经过分片之后的 IP 数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。

在分片传输中，一旦某个分片丢失，则会造成整个 IP 数据报作废，所以 TCP 引入了 `MSS` 也就是在 TCP 层进行分片不由 IP 层分片，那么对于 UDP 我们尽量不要发送一个大于 `MTU` 的数据报文。



## 15、IPv6 地址的标识方法

IPv4 地址长度共 32 位，是以每 8 位作为一组，并用点分十进制的表示方式。

IPv6 地址长度是 128 位，是以每 16 位作为一组，每组用冒号 「:」 隔开。

![image-20220917135238162](https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917135238162.png)

如果出现连续的 0 时还可以将这些 0 省略，并用两个冒号 「::」隔开。但是，一个 IP 地址中只允许出现一次两个连续的冒号。

![image-20220917135258121](https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917135258121.png)



## 16、IPv6 地址的结构

IPv6 类似 IPv4，也是通过 IP 地址的前几位标识 IP 地址的种类。

IPv6 的地址主要有以下类型地址：

- 单播地址，用于一对一的通信
- 组播地址，用于一对多的通信
- 任播地址，用于通信最近的节点，最近的节点是由路由协议决定
- 没有广播地址



>IPv6 单播地址类型

对于一对一通信的 IPv6 地址，主要划分了三类单播地址，每类地址的有效范围都不同。

- 在同一链路单播通信，不经过路由器，可以使用**链路本地单播地址**，IPv4 没有此类型
- 在内网里单播通信，可以使用**唯一本地地址**，相当于 IPv4 的私有 IP
- 在互联网通信，可以使用**全局单播地址**，相当于 IPv4 的公有 IP

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917135514662.png" alt="image-20220917135514662" style="zoom: 50%;" />



## 17、IPv4 首部与 IPv6 首部的差异

![IPv4 首部与 IPv6 首部的差异](https://ningct.oss-cn-hangzhou.aliyuncs.com/31.jpg)

IPv6 相比 IPv4 的首部改进：

- **取消了首部校验和字段。** 因为在数据链路层和传输层都会校验，因此 IPv6 直接取消了 IP 的校验。
- **取消了分片/重新组装相关字段。** 分片与重组是耗时的过程，IPv6 不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
- **取消选项字段。** 选项字段不再是标准 IP 首部的一部分了，但它并没有消失，而是可能出现在 IPv6 首部中的「下一个首部」指出的位置上。



## 18、DNS 是什么，如果工作

DNS 可以将域名网址自动转换为具体的 IP 地址

域名的层级关系类似一个树状结构：

- 根 DNS 服务器
- 顶级域 DNS 服务器（com）
- 权威 DNS 服务器（server.com）

根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中，任何 DNS 服务器就都可以找到并访问根域 DNS 服务器了。

客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器



## 19、域名解析的工作流程

浏览器首先看一下自己的缓存里有没有，如果没有就向操作系统的缓存要，还没有就检查本机域名解析文件 `hosts`，如果还是没有，就会 DNS 服务器进行查询，查询的过程如下：

1. 客户端首先会发出一个 DNS 请求，问 www.server.com 的 IP 是啥，并发给本地 DNS 服务器（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。
2. 本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 www.server.com 的 IP 地址吗？” 根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路。
3. 根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”
4. 本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com 的 IP 地址吗？”
5. 顶级域名服务器说：“我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”。
6. 本地 DNS 于是转向问权威 DNS 服务器：“老三，www.server.com对应的IP是啥呀？” server.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。
7. 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
8. 本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。



## 20、ARP是什么，如何工作

在传输一个 IP 数据报的时候，确定了源 IP 地址和目标 IP 地址后，就会通过主机「路由表」确定 IP 数据包下一跳。然而，网络层的下一层是数据链路层，所以我们还要知道「下一跳」的 MAC 地址。

由于主机的路由表中可以找到下一跳的 IP 地址，所以可以通过 **ARP 协议**，求得下一跳的 MAC 地址。



ARP 是借助 **ARP 请求与 ARP 响应**两种类型的包确定 MAC 地址的。

- 主机会通过**广播发送 ARP 请求**，这个包中包含了想要知道的 MAC 地址的主机 IP 地址。
- 当同个链路中的所有设备收到 ARP 请求时，会去拆开 ARP 请求包里的内容，如果 ARP 请求包中的目标 IP 地址与自己的 IP 地址一致，那么这个设备就将自己的 MAC 地址塞入 **ARP 响应包**返回给主机。

操作系统通常会把第一次通过 ARP 获取的 MAC 地址缓存起来，以便下次直接从缓存中找到对应 IP 地址的 MAC 地址。



## 21、RARP 协议你知道是什么吗？

ARP 协议是已知 IP 地址求 MAC 地址，那 RARP 协议正好相反，它是**已知 MAC 地址求 IP 地址**。例如将打印机服务器等小型嵌入式设备接入到网络时就经常会用得到。

通常这需要架设一台 `RARP` 服务器，在这个服务器上注册设备的 MAC 地址及其 IP 地址。然后再将这个设备接入到网络，接着：

- 该设备会发送一条「我的 MAC 地址是XXXX，请告诉我，我的IP地址应该是什么」的请求信息。
- RARP 服务器接到这个消息后返回「MAC地址为 XXXX 的设备，IP地址为 XXXX」的信息给这个设备。

最后，设备就根据从 RARP 服务器所收到的应答信息设置自己的 IP 地址。



## 22、DHCP是什么，如何工作

通过 DHCP 动态获取 IP 地址



DHCP 客户端进程监听的是 68 端口号，DHCP 服务端进程监听的是 67 端口号

- 客户端首先发起 **DHCP 发现报文（DHCP DISCOVER）** 的 IP 数据报，由于客户端没有 IP 地址，也不知道 DHCP 服务器的地址，所以使用的是 UDP **广播**通信，其使用的广播目的地址是 255.255.255.255（端口 67） 并且使用 0.0.0.0（端口 68） 作为源 IP 地址。

  DHCP 客户端将该 IP 数据报传递给链路层，链路层然后将帧广播到所有的网络中设备。

- DHCP 服务器收到 DHCP 发现报文时，用 **DHCP 提供报文（DHCP OFFER）** 向客户端做出响应。

  该报文仍然使用 IP 广播地址 255.255.255.255，该报文信息携带服务器提供可租约的 IP 地址、子网掩码、默认网关、DNS 服务器以及 **IP 地址租用期**。

- 客户端收到一个或多个服务器的 DHCP 提供报文后，从中选择一个服务器，并向选中的服务器发送 **DHCP 请求报文（DHCP REQUEST**进行响应，回显配置的参数。

- 最后，服务端用 **DHCP ACK 报文**对 DHCP 请求报文进行响应，应答所要求的参数。



一旦客户端收到 DHCP ACK 后，交互便完成了，并且客户端能够在租用期内使用 DHCP 服务器分配的 IP 地址。

如果租约的 DHCP IP 地址快期后，客户端会向服务器发送 DHCP 请求报文：

- 服务器如果同意继续租用，则用 DHCP ACK 报文进行应答，客户端就会延长租期。
- 服务器如果不同意继续租用，则用 DHCP NACK 报文，客户端就要停止使用租约的 IP 地址。

DHCP 交互中，**全程都是使用 UDP 广播通信**。



## 23、DHCP 中继代理是干什么的

DHCP使用的是广播，如果 DHCP 服务器和客户端不是在同一个局域网内，路由器又不会转发广播包，那就没有服务器响应DHCP客户端，如果每个局域网都架设DHCP服务端会使成本增加，因此使用DHCP中继代理解决这个问题。

有了 DHCP 中继代理以后，**对不同网段的 IP 地址分配也可以由一个 DHCP 服务器统一进行管理。**



- DHCP 客户端会向 DHCP 中继代理发送 DHCP 请求包，而 DHCP 中继代理在收到这个广播包以后，再以**单播**的形式发给 DHCP 服务器。
- 服务器端收到该包以后再向 DHCP 中继代理返回应答，并由 DHCP 中继代理将此包广播给 DHCP 客户端 。



## 24、NAT是什么，如何工作

 NAT 就是同个公司、家庭、教室内的主机对外部通信时，把私有 IP 地址转换成公有 IP 地址。

NAT把 IP 地址 + 端口号一起进行转换，共用用一个全球 IP 地址，这种转换技术就叫**网络地址与端口转换 NAPT**

对不同的私有地址，用不同的端口映射，生成一个转换表。



## 25、NAT有什么不足

- 外部无法主动与 NAT 内部服务器建立连接，因为 NAPT 转换表没有转换记录。
- 转换表的生成与转换操作都会产生性能开销。
- 通信过程中，如果 NAT 路由器重启了，所有的 TCP 连接都将被重置。



## 26、如何解决 NAT 潜在的问题呢？

**改用 IPv6**

IPv6 可用范围非常大，以至于每台设备都可以配置一个公有 IP 地址，就不搞那么多花里胡哨的地址转换了，但是 IPv6 普及速度还需要一些时间。

**NAT 穿透技术**

NAT 穿越技术能够让网络应用程序主动发现自己位于 NAT 设备之后，主动获得 NAT 设备的公有 IP，并为自己建立端口映射条目，然后用这个条目对外通信，就不需要 NAT 设备来进行转换了。



## 27、ICMP是什么，如何工作

`ICMP` 主要的功能包括：**确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等。**

在 `IP` 通信中如果某个 `IP` 包因为某种原因未能达到目标地址，那么这个具体的原因将**由 ICMP 负责通知**。



假如主机 `A` 向主机 `B` 发送了数据包，由于某种原因，途中的路由器 `2` 未能发现主机 `B` 的存在，这时，路由器 `2` 就会向主机 `A` 发送一个 `ICMP` 目标不可达数据包，说明发往主机 `B` 的包未能成功。

ICMP 的这种通知消息会使用 `IP` 进行发送 。

因此，从路由器 `2` 返回的 ICMP 包会按照往常的路由控制先经过路由器 `1` 再转发给主机 `A` 。

收到该 ICMP 包的主机 `A` 则分解 ICMP 的首部和数据域以后得知具体发生问题的原因。



ICMP 大致可以分为两大类：

- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/41.jpg" alt="常见的 ICMP 类型" style="zoom:50%;" />



## 28、IGMP是什么，如何工作

**IGMP 是因特网组管理协议，工作在主机（组播成员）和最后一跳路由之间**

- IGMP 报文向路由器申请加入和退出组播组，默认情况下路由器是不会转发组播包到连接中的主机，除非主机通过 IGMP 加入到组播组，主机申请加入到组播组时，路由器就会记录 IGMP 路由器表，路由器后续就会转发组播包到对应的主机了。
- IGMP 报文采用 IP 封装，IP 头部的协议号为 2，而且 TTL 字段值通常为 1，因为 IGMP 是工作在主机与连接的路由器之间。



**工作机制**

1. 路由器会周期性发送目的地址为 `224.0.0.1`（表示同一网段内所有主机和路由器） **IGMP 常规查询报文**。
2. 主机1 和 主机 3 收到这个查询，随后会启动「报告延迟计时器」，计时器的时间是随机的，通常是 0~10 秒，计时器超时后主机就会发送 **IGMP 成员关系报告报文**（源 IP 地址为自己主机的 IP 地址，目的 IP 地址为组播地址）。如果在定时器超时之前，收到同一个组内的其他主机发送的成员关系报告报文，则自己不再发送，这样可以减少网络中多余的 IGMP 报文数量。
3. 路由器收到主机的成员关系报文后，就会在 IGMP 路由表中加入该组播组，后续网络中一旦该组播地址的数据到达路由器，它会把数据包转发出去。



**离开组播组**

1. 主机 1 要离开组 224.1.1.1，发送 IGMPv2 离组报文，报文的目的地址是 224.0.0.2（表示发向网段内的所有路由器）
2. 路由器 收到该报文后，以 1 秒为间隔连续发送 IGMP 特定组查询报文（共计发送 2 个），以便确认该网络是否还有 224.1.1.1 组的其他成员。
3. 主机 3 仍然是组 224.1.1.1 的成员，因此它立即响应这个特定组查询。路由器知道该网络中仍然存在该组播组的成员，于是继续向该网络转发 224.1.1.1 的组播数据包。
4. 一段时间后没有收到特定组查询响应，路由器将认为网络内不存在该组成员，不会对改组传播进行转发



## 29、ICMP 包头格式

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917151900057.png" alt="image-20220917151900057" style="zoom: 67%;" />

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917151925827.png" alt="image-20220917151925827" style="zoom:67%;" />



> 查询报文类型

回送消息 —— 类型 `0` 和 `8`

**回送消息**用于进行通信的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的一种消息，`ping` 命令就是利用这个消息实现的。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917152407843.png" alt="image-20220917152407843" style="zoom:67%;" />

可以向对端主机发送**回送请求**的消息（`ICMP Echo Request Message`，类型 `8`）

可以接收对端主机发回来的**回送应答**消息（`ICMP Echo Reply Message`，类型 `0`）

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917152434418.png" alt="image-20220917152434418" style="zoom: 80%;" />

相比原生的 ICMP，这里多了两个字段：

- **标识符**：用以区分是哪个应用程序发 ICMP 包，比如用进程 `PID` 作为标识符；
- **序号**：序列号从 `0` 开始，每发送一次新的回送请求就会加 `1`， 可以用来确认网络包是否有丢失。

在**选项数据**中，`ping` 还会存放发送请求的时间值，来计算往返时间，说明路程的长短



> 差错报文类型

- 目标不可达消息 —— 类型 为 `3`

  IP 路由器无法将 IP 数据包发送给目标地址时，会给发送端主机返回一个**目标不可达**的 ICMP 消息，并在这个消息中显示不可达的具体原因，原因记录在 ICMP 包头的**代码**字段。

  ```text
  网络不可达代码为 0
  	路由器找不到网络号
  主机不可达代码为 1
  	路由器找不到主机号对于主机
  协议不可达代码为 2
  	对端主机不接收本次发送信息使用的协议，可能是开启了防火墙
  端口不可达代码为 3
  	目标端口没有被监听
  需要进行分片但设置了不分片位代码为 4
  	发送方设置了不允许路由器进行分片，但是路由器需要分片的时候回复
  ```

- 原点抑制消息 —— 类型 `4`

  在使用低速广域线路的情况下，连接 WAN 的路由器可能会遇到网络拥堵的问题。

  `ICMP` 原点抑制消息的目的就是**为了缓和这种拥堵情况**。

  当路由器向低速线路发送数据时，其发送队列的缓存变为零而无法发送出去时，可以向 IP 包的源地址发送一个 ICMP **原点抑制消息**。

  收到这个消息的主机借此了解在整个线路的某一处发生了拥堵的情况，从而增大 IP 包的传输间隔，减少网络拥堵的情况。

- 重定向消息 —— 类型 `5`

  如果路由器发现发送端主机使用了「不是最优」的路径发送数据，那么它会返回一个 ICMP **重定向消息**给这个主机。

  在这个消息中包含了**最合适的路由信息和源数据**。

- 超时消息 —— 类型 `11`

  IP 包中有一个字段叫做 `TTL` （`Time To Live`，生存周期），它的**值随着每经过一次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。**

  此时，路由器将会发送一个 ICMP **超时消息**给发送端主机，并通知该包已被丢弃。



## 30、ping是如何实现的

ping 命令执行的时候，源主机首先会构建一个 **ICMP 回送请求消息**数据包。

ICMP 数据包内包含多个字段，最重要的是两个：

- 第一个是**类型**，对于回送请求消息而言该字段为 `8`；
- 另外一个是**序号**，主要用于区分连续 ping 的时候发出的多个数据包。

每发出一个请求数据包，序号会自动加 `1`。为了能够计算往返时间 `RTT`，它会在报文的数据部分插入发送时间。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917153534580.png" alt="image-20220917153534580" style="zoom:67%;" />

然后，由 ICMP 协议将这个数据包连同地址 192.168.1.2 一起交给 IP 层。

IP 层将以 192.168.1.2 作为**目的地址**，本机 IP 地址作为**源地址**，**协议**字段设置为 `1` 表示是 `ICMP` 协议，再加上一些其他控制信息，构建一个 `IP` 数据包。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917153621725.png" alt="image-20220917153621725" style="zoom:67%;" />

下来，需要加入 `MAC` 头。如果在本地 ARP 映射表中查找出 IP 地址 192.168.1.2 所对应的 MAC 地址，则可以直接使用；

如果没有，则需要发送 `ARP` 协议查询 MAC 地址，获得 MAC 地址后，由数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址则是本机的 MAC 地址；还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

<img src="https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917153652262.png" alt="image-20220917153652262" style="zoom:67%;" />



主机 `B` 收到这个数据帧后，先检查它的目的 MAC 地址，并和本机的 MAC 地址对比，如符合，则接收，否则就丢弃。

接收后检查该数据帧，将 IP 数据包从帧中提取出来，交给本机的 IP 层。同样，IP 层检查后，将有用的信息提取后交给 ICMP 协议。

主机 `B` 会构建一个 **ICMP 回送响应消息**数据包，回送响应数据包的**类型**字段为 `0`，**序号**为接收到的请求数据包中的序号，然后再发送出去给主机 A。

![image-20220917153731824](https://ningct.oss-cn-hangzhou.aliyuncs.com/image-20220917153731824.png)

在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收到了 ICMP 回送响应消息，则说明目标主机可达。

此时，源主机会检查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是 ICMP 数据包的时间延迟。



## 31、traceroute是什么，如果工作

> 获取路由信息

traceroute 的第一个作用就是**故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。**

利用 IP 包的**生存期限** 从 `1` 开始按照顺序递增的同时发送 **UDP 包**，强制接收 **ICMP 超时消息**的一种方法。

比如，将 TTL 设置 为 `1`，则遇到第一个路由器，就牺牲了，接着返回 ICMP 差错报文网络包，类型是**时间超时**。

接下来将 TTL 设置为 `2`，第一个路由器过了，遇到第二个路由器也牺牲了，也同时返回了 ICMP 差错报文数据包，如此往复，直到到达目的主机。

这样的过程，traceroute 就可以拿到了所有的路由器 IP。

> 确认UDP是否到达

traceroute 在发送 `UDP` 包时，会填入一个**不可能的端口号**值作为 UDP 目标端口号：33434。

当目的主机，收到 UDP 包后，会返回 ICMP 差错报文消息，但这个差错报文消息的类型是「**端口不可达**」。

> 确定路径的 MTU

首先在发送端主机发送 `IP` 数据报时，将 `IP` 包首部的**分片禁止标志位设置为 1**。

根据这个标志位，途中的路由器不会对大数据包进行分片，而是将包丢弃。

随后，通过一个 ICMP 的不可达消息将**数据链路上 MTU 的值**一起给发送主机，不可达消息的类型为「**需要进行分片但设置了不分片位**」。

发送主机端每次收到 ICMP 差错报文时就**减少**包的大小，以此来定位一个合适的 `MTU` 值，以便能到达目标主机。