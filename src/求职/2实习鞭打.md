> 介绍一下

给一个用户放贷之前，需要去评估他资信等级，以及风险级别，会有非常多的数据去计算一个值去评估，会存在大量相似的计算，比如函数运算，条件转换，时间点计算，数组计算，频次统计，相似比较等。对于一些有价值的数据，比如资产水平，收入水平，逾期记录，借贷类APP安装数量，生活稳定性等，可以抽象出来，成为一个变量，并配置它的计算逻辑，只需要提供计算的字段，数据源等信息，就能得到想要的结果。



这个变量不是随便都能申请的，需要提交审核，需要人工审批，以及做好的变量，需要发布上线，同步给提供给资信系统，风控系统使用。变量需要更新了就下线，下线同样需要人工审核，之后别的系统就不能再使用这个变量去计算东西了。我做的就是变量在这个上线下线流程中各种状态流转的后端代码实现，每一个状态的转化都需要对它做一些校验，然后做一些处理，最后做状态的变化，写入数据库。



我用了两个工厂来实现流程控制代码的封装，对于各种操作类型，比如新建，提交审核，审核上线，发布，同步，撤销等操作，抽象了一个基类去实现通用步骤的代码复用，这些通用步骤就是先做校验，校验状态是否合法，信息是否充足，权限是否足够，然后做状态的转化，最后做结果的封装。把所有的操作器注册到一个工厂，根据类型获取具体操作器，执行处理。



操作器只是做了一个具体的执行步骤和一些通用的处理，比如到封装了这个操作应该验证哪些参数，要做哪些操作，有些跟状态控制无关，和具体的实体有关的操作，交给具体的业务对象实现。因为这个审批过程，不仅适用于变量，还有其它的实体，可以复用这一套流程，比如变量的集合等想要走审批上线发布流程的实体。



具体业务对象也是通过工厂来获取的。开发其它实体的流转控制功能的时候，只需要开发这个具体的业务对象，把它注入到工厂里，在controller层指定操作的类型还有业务对象的名称就行。



然后就是做了变量信息的导入导出，对支持json格式和excel格式，excel格式是有easyexcel做的。



然后就是调用了其它系统的几个rpc接口，作了一些编译和验证的工作。因为变量的计算有很多个模板去解析，解析之后会生成一个sql语句，语句中有一些属性，这些属性是在计算的时候传进来的，然后执行这个sql就能得到结果。



> 计算逻辑是怎么编译成sql的

前端会配置一些信息，比如，有哪些变量，哪些字段参与计算，用的是哪个模板去算。

每一个计算模板都有一个sql模板，但是需要根据具体参数才能生成具体的sql，比如sql模板里对某个参数要做条件判断，做遍历，做加减乘除之类的。

拿到模板的名称，以及参数列表，就会去找到模板定义的sql，根据参数列表生成具体能执行的sql语句。

之后对这个sql有一个验证的动作，判断语法是不是正确的。这个验证使用的是一个远程的接口。

还可以传入具体的属性值，去看看这个sql是不是能计算出预期的结果，这个也是使用远程接口进行的验证。



> 难点

起始技术上没有什么难点，困难更多出现在业务理解和需求理解上边。因为这个把计算抽离出来用模板配置的想法，我之前一直是没有概念的，不像面向用户使用的功能那样平时接触的到，好理解。



程序需要运行在公司提供的一个容器，里边做好了各种依赖的提供，提供了项目运行需要的环境。而且实现了开发的模板，类似于springboot，应该有哪些目录，哪些文件，默认的配置，接口应该怎么暴露，怎么引入。



在使用远程接口的时候，遇到一个包冲突的错误，有一个依赖的一部分迁移到了另外一个依赖，做了新的实现，但是这两个依赖的导入没有做包的排除，导致不能正确获取到我想要的接口。找到原因之后，在旧的依赖排除了包，最后成功调用。



还有就是git的使用，因为不是一个人在开发，经常会遇到代码冲突的问题，这个在之前自己单独进行开发的时候没有遇到的问题，在合并的时候还出错过，做了版本的回退。